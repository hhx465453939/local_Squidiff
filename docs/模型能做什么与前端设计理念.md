# Squidiff：模型能做什么？—— 从论文到前端的根本目标与设计理念

> 本文档回答：「这个项目训练了一个模型，然后呢？能做什么？」  
> 并基于原论文与代码能力，明确**项目前端使用设计的根本性目标和理念**，供产品与开发一致遵循。

---

## 1. 需求审计：用户到底在疑惑什么？

很多用户（尤其是非算法同事）的典型疑问是：

- 训练完模型之后，**具体能做什么**？
- 从「上传数据」到「拿到结果」，**整条链路每一步对应什么科学含义**？
- 前端页面应该**优先呈现什么**，才能让人一眼看懂「我在用 Squidiff 解决什么问题」？

因此需要：

1. **说清原论文里 Squidiff 的科学目标与验证场景**；
2. **按时间线梳理**：训练前准备什么 → 训练在学什么 → 训练好后能执行哪些操作；
3. **把这些能力翻译成前端/产品的根本目标与设计原则**，让「模型能做什么」直接驱动界面与流程设计。

---

## 2. 原论文与科学依据

### 2.1 论文信息

| 项目 | 内容 |
|------|------|
| **标题** | Squidiff: predicting cellular development and responses to perturbations using a diffusion model |
| **作者** | He S, Zhu Y, Tavakol DN, Ye H, Lao YH, Zhu Z, Xu C, Chauhan S, Garty G, Tomer R, Vunjak-Novakovic G, Zou J, Azizi E, Leong KW 等（哥伦比亚大学、斯坦福大学等） |
| **期刊** | *Nature Methods* (2026), 23(1): 65–77 |
| **DOI** | 10.1038/s41592-025-02877-y |
| **预印本** | bioRxiv 2024.11.16.623974 (2025-08-26 更新) |
| **链接** | [PubMed 41184550](https://pubmed.ncbi.nlm.nih.gov/41184550/) |

### 2.2 论文核心信息（摘要提炼）

- **问题**：单细胞测序能刻画细胞异质性与对环境刺激的响应，但**在不同细胞类型、不同刺激下系统性地刻画转录组变化、并揭示疾病机制**仍然困难；涉及物理刺激（如放疗）或化学刺激（如药物）的实验往往费时费力，制约机制解析与药物发现。
- **方法**：Squidiff 是一个**基于扩散模型的条件生成框架**，在「环境/条件」条件下预测**多种细胞类型**的转录组变化。
- **验证场景**（论文中明确展示）：
  - **细胞分化**（cell differentiation）
  - **基因扰动**（gene perturbation）
  - **药物响应预测**（drug response prediction）
- **进一步应用示例**：血管类器官发育、中子辐照与生长因子等刺激下的细胞响应。
- **能力总结**：通过连续去噪与语义特征整合，Squidiff 学习**瞬时细胞状态**，并预测**随时间与条件变化的高分辨率转录组景观**；支持**计算机模拟（in silico）筛选分子景观与细胞状态转换**，用于快速产生假设、理解细胞命运决定的调控原则。

上述内容直接对应「**训练好模型之后可以做什么**」的科学依据。

---

## 3. 从训练前到训练后：全流程能做什么

下面按**训练前 → 训练中 → 训练后**梳理本仓库中与论文一致的能力边界，并对应到脚本/API/前端概念。

### 3.1 训练前：数据与条件定义

| 阶段 | 做什么 | 科学含义 | 在本项目中的实现 |
|------|--------|----------|-------------------|
| **数据准备** | 单细胞转录组（h5ad）+ 可选对照与药物信息 | 定义「谁在什么条件下」的观测 | 上传/校验/转换（Seurat→h5ad）；预处理（cluster 筛选、500×500 等） |
| **条件定义** | 基础模式：`Group`（如时间点、发育阶段）<br>药物模式：`SMILES` + `dose` + 对照 | 模型学习的「条件」：发育轨迹或药物/剂量 | `train_squidiff.py` 的 `use_drug_structure`、`control_data_path`；`.obs` 中的 `Group` / `SMILES` / `dose` |
| **预处理** | 细胞/基因筛选、归一化等 | 控制输入规模与质量，与论文设定对齐 | LabFlow 的 prepare-training（cluster、分层抽样、基因数上限） |

**结论**：训练前的工作是在**定义「条件→转录组」的映射空间**；前端应让用户明确「当前数据代表哪种应用」（发育 / 基因扰动 / 药物响应），并正确配置条件字段。

### 3.2 训练中：模型在学什么

- 模型学习的是：在给定**条件**（如 Group 或 SMILES+dose）下，从噪声/潜在表示**去噪生成**对应的转录组。
- 编码器将细胞转录组编码为语义潜在向量 `z_sem`；扩散模型在条件 `z_mod`（由条件 + 可选药物指纹等构成）下学习转录组分布。
- **训练完成**的产出：checkpoint（如 `model.pt`）+ 与训练数据一致的 `gene_size` / `output_dim` 等参数。

**结论**：训练阶段不需要用户「操作模型」，但前端应暴露「任务状态、日志、是否使用药物结构」等，以便用户理解**当前训练对应哪种科学设定**。

### 3.3 训练后：模型能做的具体事情（论文 + 代码对应）

以下能力在论文中有对应场景，并在本仓库的 `sample_squidiff.py` 或后端预测流程中有实现或接口：

| 能力 | 论文/科学含义 | 本仓库中的实现 | 前端/产品含义 |
|------|----------------|----------------|----------------|
| **1. 条件转录组预测** | 给定条件（如某一时间点、某一药物+剂量），预测该条件下细胞的转录组 | `sampler.pred(z_sem, gene_size)`：由编码后的 `z_sem`（可含条件）生成预测转录组 | 「选模型 + 选测试数据 → 得到预测矩阵」；结果可导出、可视化 |
| **2. 批量预测与可视化** | 对大量细胞/条件做 in silico 预测，替代部分湿实验 | `run_predict`：批量编码→预测→保存 `.npy`；可选 UMAP/热图等可视化 | 结果页展示预测矩阵的统计与图表；支持下载 |
| **3. 潜在空间插值** | 沿某一方向探索「条件-转录组」空间，用于假设生成 | `sampler.interp_with_direction(z_sem_origin, gene_size, direction, scale)` | 未来可设计「方向+强度」控件，展示沿方向变化的预测（当前 LabFlow 未实现） |
| **4. 编码-解码语义** | 细胞→潜在表示→再生成，用于理解模型学到的状态 | `sampler.model.encoder(x)` + `sampler.pred(z_sem, gene_size)` | 预测流程本质即「编码→条件生成」；前端可强调「输入细胞/条件 → 输出预测转录组」 |

因此，**「训练了模型然后呢？」** 的直白回答是：

- **立刻能做的**：用训练好的模型对**新样本/新条件**做**批量转录组预测**，得到预测矩阵与可视化（UMAP、热图等），用于 in silico 筛选、假设生成或与实验对比。
- **论文还展示的**：细胞分化、基因扰动、药物响应等多种场景；本仓库通过「基础模式 vs 药物结构模式」支持其中一部分，前端应通过文案与流程让人理解「当前是哪种应用」。

---

## 4. 作为项目前端使用设计的根本目标与理念

基于上述「模型能做什么」，下面给出**前端使用设计的根本性目标和理念**，供需求、交互与实现一致遵循。

### 4.1 根本目标（Why we build the UI）

1. **消除「训练完不知道能干什么」的困惑**  
   在结果页与全局文案中，明确传达：**「用你训练好的模型，对新数据做转录组预测，得到 in silico 结果与图表」**；并可选地区分「发育/扰动/药物」等应用场景。

2. **让「数据 → 训练 → 预测 → 结果」形成可理解的闭环**  
   用户应能在最少点击内理解：  
   - 我上传的数据代表什么条件；  
   - 训练产出了哪个模型；  
   - 预测时用了哪个模型、哪份数据；  
   - 结果图/表对应什么（预测矩阵、UMAP、分组统计等）。

3. **服务于论文所对应的科学用途**  
   界面与文案应对齐论文中的三大类应用（细胞分化、基因扰动、药物响应），使「选数据/选条件」与「模型能做什么」一致，避免泛泛的「AI 预测」表述。

### 4.2 设计理念（How we design）

1. **流程即故事线**  
   上传 → 校验 → 预处理 → 训练 → （选择模型）→ 预测 → 结果，每一步都应有一句简短说明：「这一步在干什么、为什么需要」。例如：「用这份预处理数据训练出的模型，将用于对新样本做转录组预测。」

2. **结果页是「模型能做什么」的展示台**  
   结果页不应只是「任务成功」或「文件列表」，而应突出：  
   - 预测矩阵的统计摘要；  
   - 可视化（UMAP、热图等）及其图例（条件/分组）；  
   - 下载与复现信息（模型 ID、数据来源、参数摘要）。  
   这样用户一眼能看到「模型真的在预测转录组并产生可解释输出」。

3. **条件与模式可见**  
   在训练/预测配置处，明确展示当前是「基础模式（如 Group）」还是「药物结构模式（SMILES+dose）」；可选：用简短提示说明「药物模式用于药物响应预测，与论文中 drug response 场景一致」。

4. **内网、小团队、可复现优先**  
   不追求酷炫交互，而追求：任务可追溯（来源数据、模型、参数）、结果可下载、日志可查；便于实验室内讨论与复现，与 PRD 中的「实验室内网单细胞训练预测平台」定位一致。

### 4.3 与现有 PRD 的关系

- **PRD_实验室内网单细胞训练预测平台.md** 已定义：上传 → 校验 → 训练 → 预测 → 可视化；默认「固定模型给新样本做批量预测」。
- 本文档**不改变**既有功能范围，而是从**科学依据与用户心智**出发，明确：  
  - **「模型能做什么」**来自论文（分化/扰动/药物响应 + in silico 筛选）；  
  - **前端存在的理由**是让人理解并顺畅完成「数据→训练→预测→结果」闭环；  
  - **设计原则**应围绕「消除困惑、流程即故事、结果即证明、条件可见、可复现」。

后续若增加「潜在空间插值」等高级能力，前端可在此基础上增加对应入口与说明，仍遵循同一套根本目标与理念。

---

## 5. 文档与引用

- **原论文**：He S, Zhu Y, et al. Squidiff: predicting cellular development and responses to perturbations using a diffusion model. *Nat Methods* 2026;23(1):65-77. DOI: [10.1038/s41592-025-02877-y](https://doi.org/10.1038/s41592-025-02877-y).
- **本仓库**：README.md（功能总览）、CLAUDE.md（开发指南）、PRD_实验室内网单细胞训练预测平台.md（MVP 范围）、部署文档与 Seurat 相关文档见 `docs/`。

---

*文档版本：基于 2026-02 项目状态与 Nat Methods 论文信息整理；若论文有更新以官方出版物为准。*
