# Squidiff 避坑指南（精简版）

> 本文保留高频问题速查。环境与运行流程详见 `docs/部署文档.md`，数据转换详见 `docs/seurat转换指南.md`。

## 1. 先做这 5 件事

1. 激活正确虚拟环境（确认 `python` 指向 `.venv`）。
2. 跑一次 `python -m ruff check .`。
3. 检查数据维度：`python scripts/check_shape.py --data_path <file.h5ad>`。
4. 确认训练参数：`gene_size == output_dim == adata.n_vars`。
5. 使用药物结构时，确认 `SMILES`、`dose` 和 `control_data_path` 同时存在。

## 2. 高频报错对照

| 错误 | 典型原因 | 快速处理 |
|---|---|---|
| `KeyError: 'Group'` | 缺少 `Group` 列 | 在数据中补齐 `adata.obs["Group"]` |
| `KeyError: 'SMILES'` / `KeyError: 'dose'` | 药物结构训练但字段缺失 | 补齐列或关闭 `use_drug_structure` |
| `mat1 and mat2 shapes cannot be multiplied` | 维度不一致 | 回填 `--gene_size`/`--output_dim` 为 `adata.n_vars` |
| `CUDA out of memory` | 显存不足 | 降低 `batch_size`/`gene_size`，启用 `use_fp16` |
| `ModuleNotFoundError` | 依赖不完整 | 重新安装依赖并检查环境激活状态 |

## 3. 训练前检查模板

```bash
# 1) 代码质量
python -m ruff check .

# 2) 数据维度
python scripts/check_shape.py --data_path path/to/train.h5ad

# 3) 启动训练（示例）
python train_squidiff.py \
  --logger_path "./results/exp1" \
  --data_path "path/to/train.h5ad" \
  --resume_checkpoint "./checkpoints/exp1" \
  --gene_size 159 \
  --output_dim 159
```

## 4. 推理前检查模板

1. 模型文件存在且路径正确。  
2. 推理参数与训练参数一致（尤其是 `gene_size`、`output_dim`、`use_drug_structure`）。  
3. 测试数据基因维度与训练一致。  

## 5. 建议的工程实践

- 每次训练保存参数快照（JSON）。
- 将实验日志目录按日期和主题命名。
- 小样本冒烟验证通过后再跑全量训练。
