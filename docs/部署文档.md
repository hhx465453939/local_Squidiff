# Squidiff 部署与运行文档

> 合并说明：本文件已整合原 `部署文档.md` 与 `环境安装指南.md`，作为统一入口。

## 1. 适用范围

- 本文用于本地环境搭建、依赖安装、训练/推理运行与最小化验证。
- Seurat 数据转换请看 `docs/seurat转换指南.md`。
- 排错与快速定位请看 `docs/避坑指南.md`。

## 2. 环境要求

### 2.1 硬件建议

| 组件 | 最低配置 | 推荐配置 |
|---|---|---|
| CPU | 4 核 | 8 核及以上 |
| 内存 | 16 GB | 32 GB 及以上 |
| GPU | GTX 1060 6GB | RTX 3090/4090 24GB |
| 存储 | 50 GB | 100 GB+ SSD |

### 2.2 软件建议

- **Python**: `3.9`, `3.10`, `3.11`（推荐 3.11）
  - ⚠️ **Python 3.13 兼容性**：当前 `scanpy>=1.10.0` 支持 Python 3.9-3.11；Python 3.13 需等待 `scanpy>=1.12.0`（开发中）
- **操作系统**: Windows / Linux / macOS
- **GPU 与 CUDA**: 
  - ⚠️ **必须使用 GPU**：Squidiff 训练需要 GPU，不支持 CPU 训练
  - 必须安装 CUDA 版本的 PyTorch（根据本机 CUDA 版本选择，常见为 CUDA 11.8 或 12.1）
  - 查看 CUDA 版本：`nvidia-smi`
- **运行方式**：仅三种——**uv**、**conda**、**本机 Python**（venv + pip）。任选其一装好依赖后，用同一条命令启动后端。
- **国内用户**：可配置 PyPI 镜像（见下文表格），加速安装。

## 3. 安装流程（三选一）

### 3.1 uv

```bash
pip install uv
uv venv
# Windows: .venv\Scripts\activate   # Linux/macOS: source .venv/bin/activate
# PyTorch（CUDA）：nvidia-smi 看版本后选 cu118 或 cu121
uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
uv pip install -r requirements.txt -r backend/requirements.txt --extra-index-url https://download.pytorch.org/whl/cu118
```

国内镜像：`$env:UV_INDEX_URL="https://pypi.tuna.tsinghua.edu.cn/simple"`（PowerShell）或 `export UV_INDEX_URL=...`（bash），再执行上述 `uv pip install`。

### 3.2 conda

```bash
conda create -n labflow python=3.11
conda activate labflow
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
pip install -r requirements.txt -r backend/requirements.txt --extra-index-url https://download.pytorch.org/whl/cu118
```

### 3.3 本机 Python（venv + pip）

```bash
python -m venv .venv
# Windows: .venv\Scripts\activate   # Linux/macOS: source .venv/bin/activate
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
pip install -r requirements.txt -r backend/requirements.txt --extra-index-url https://download.pytorch.org/whl/cu118
```

### 3.4 国内镜像（可选）

| 镜像 | PyPI 地址 |
|------|------------|
| 清华 | `https://pypi.tuna.tsinghua.edu.cn/simple` |
| 阿里云 | `https://mirrors.aliyun.com/pypi/simple/` |

## 4. 安装验证

### 4.1 验证核心依赖

```bash
python -c "import torch, scanpy, anndata, numpy; print('core ok')"
python -c "from rdkit import Chem; print('rdkit ok')"
```

### 4.2 验证 CUDA 可用性（重要）

```bash
python -c "import torch; print(f'PyTorch version: {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}'); print(f'CUDA version: {torch.version.cuda if torch.cuda.is_available() else \"N/A\"}')"
```

⚠️ **必须确认输出 `CUDA available: True`**，否则无法进行 GPU 训练。

### 4.3 验证代码质量

```bash
python -m ruff check .
```

## 5. 启动 LabFlow Web（开发/部署）

后端（在项目根目录、已激活环境中）：

```bash
uv run python -m uvicorn backend.app.main:app --reload --host 0.0.0.0 --port 8000
```

前端：

```bash
cd frontend && npm install && npm run dev
```

- 前端：http://localhost:5173  
- 后端：http://localhost:8000  

Docker 一键见 README 第 5.4 节与 `infra/.env.example`。

### 5.1 Windows 一键启动器（推荐内网长期运行）

如果你在 Windows 服务器上部署，推荐使用项目内置启动器统一拉起前后端：

```powershell
python labflow_launcher.py
```

说明：
- 启动器默认使用前端 `preview` 模式（非 `dev`），更适合长期运行。
- 默认监听 `0.0.0.0:5173`（前端）与 `0.0.0.0:8000`（后端）。
- 可打包为 `LabFlowLauncher.exe` 给管理员双击启动。

完整参数、EXE 打包与故障排查见：`docs/Windows一键启动器.md`。

## 6. 数据准备

### 6.1 最低输入要求

- `adata.X`：表达矩阵
- `adata.obs["Group"]`：分组标签
- 若 `use_drug_structure=True`：必须包含 `SMILES` 与 `dose`

### 6.2 维度一致性

先检查数据维度：

```bash
python scripts/check_shape.py --data_path path/to/train.h5ad
```

将输出的基因数同时用于：
- `--gene_size`
- `--output_dim`

## 7. 训练

### 7.1 基础训练

```bash
python train_squidiff.py \
  --logger_path "./results/baseline" \
  --data_path "path/to/train.h5ad" \
  --resume_checkpoint "./checkpoints/baseline" \
  --gene_size 159 \
  --output_dim 159
```

### 7.2 药物结构训练

```bash
python train_squidiff.py \
  --logger_path "./results/drug" \
  --data_path "path/to/train.h5ad" \
  --control_data_path "path/to/control.h5ad" \
  --resume_checkpoint "./checkpoints/drug" \
  --use_drug_structure True \
  --gene_size 159 \
  --output_dim 159
```

## 8. 推理

```python
import torch
import scanpy as sc
import sample_squidiff

sampler = sample_squidiff.sampler(
    model_path="checkpoints/baseline/model.pt",
    gene_size=159,
    output_dim=159,
    use_drug_structure=False,
)

adata = sc.read_h5ad("path/to/test.h5ad")
z_sem = sampler.model.encoder(torch.tensor(adata.X).to("cuda"))
pred = sampler.pred(z_sem, gene_size=adata.shape[1])
```

## 9. 常见运维问题

### 9.1 `CUDA out of memory`

- 降低 `--batch_size`
- 降低 `--gene_size`
- 启用 `--use_fp16 True`

### 9.2 维度不匹配 (`mat1 and mat2 shapes cannot be multiplied`)

- 检查 `adata.n_vars`
- 重新对齐 `--gene_size` 与 `--output_dim`

### 9.3 RDKit 安装失败

- 优先使用镜像源：`uv pip install --index-url https://pypi.tuna.tsinghua.edu.cn/simple rdkit`
- 或使用 pip：`pip install -i https://pypi.tuna.tsinghua.edu.cn/simple rdkit`
- 备选：`conda install -c conda-forge rdkit`

### 9.4 网络连接问题（国内用户）

- 优先使用国内镜像源（见 3.3 节）
- 如 PyTorch 下载慢，可使用清华镜像的 PyTorch 源
- 如仍有问题，考虑使用代理或 VPN

## 10. 推荐实践

- 每次训练保存参数快照（JSON）
- 固定依赖版本后再做批量实验
- 先跑小样本验证，再上全量训练
## 5.5 登录认证（内网轻量模式）

后端已内置本地 SQLite 认证（适合实验室内网自用）。

可选环境变量：
- `LABFLOW_AUTH_REQUIRED=true|false`：是否强制除 `/api/health` 和 `/api/auth/*` 外的 API 登录后访问（默认 `true`）。
- `LABFLOW_AUTH_DB_PATH=<path>`：认证数据库路径（默认 `backend/state/auth.db`）。
- `LABFLOW_AUTH_SESSION_TTL_HOURS=<hours>`：登录会话有效期（默认 `12`）。

示例（PowerShell）：
```powershell
$env:LABFLOW_AUTH_REQUIRED="true"
$env:LABFLOW_AUTH_SESSION_TTL_HOURS="12"
uv run python -m uvicorn backend.app.main:app --reload --host 0.0.0.0 --port 8000
```

前端使用方式：
1. 打开首页先注册/登录。
2. 点击“开始分析”进入流程。
3. 需要帮助时点“用户说明书”。

## 5.6 用户任务并发模式（简化版）

登录后每个用户都可以在左侧 `Task Center` 里切换自己的调度模式：

- `Serial (1)`：当前用户任务串行执行（同一时间最多 1 个运行）
- `Parallel (3)`：当前用户任务并行执行（同一时间最多 3 个运行）

说明：
- 这是“按用户”生效，不是全局开关。
- 不同用户之间互不影响，可同时各自运行任务。
- 新注册用户默认 `Parallel (3)`，可在前端随时切换为 `Serial (1)`。
- 当前实现不做硬算力仲裁，实验室可按实际 GPU 情况自行协商使用。
